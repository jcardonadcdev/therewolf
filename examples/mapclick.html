<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Therewolf</title>
    <link rel="stylesheet" href="//js.arcgis.com/3.13/esri/css/esri.css">
    <link rel="stylesheet" href="//js.arcgis.com/3.13/dijit/themes/claro/claro.css">
    <style type="text/css">
      html, body {
        height: 100%; width: 100%;
        margin: 0; padding: 0;
      }
      body{
        background-color: #fff; overflow:hidden;
        font-family: sans-serif;
      }
      #map{
        width: 100%;
        height: 85%;
      }
    </style>
    <script>
      var dojoConfig = {
        isDebug: true,
        async: true,
        paths: {
          wolf: location.pathname.replace(/\/[^/]+$/, "").replace("examples", "")
        }
      };
    </script>
    <script src="//js.arcgis.com/3.13/"></script>
    <script>
      require([
            "esri/map",
            "esri/layers/FeatureLayer",
            "wolf/therewolf",
            "dojo/on",
            "dojo/request",
            "dojo/domReady!"
      ], function(Map, FeatureLayer, Therewolf, on, request){
        var app = {};

        function init(){
          //make new Therewolf
          var therewolf = new Therewolf();

          //make map
          app.map = new Map("map", {
            basemap: "topo",
            center: [-100, 50],
            zoom: 3
          });

          //make call to get county data
          request("../data/countiesFColl.json", {
            handleAs: "json"
          }).then(function(dataC){
            //add county featurelayer to map
            var layerC = new FeatureLayer(dataC);
            app.map.addLayer(layerC);

            //add county data to Therewolf
            therewolf.add("Counties", dataC);

            //make call to get state data
            request("../data/statesFColl.json", {
              handleAs: "json"
            }).then(function(dataS){
              //add states featurelayer to map
              var layerS = new FeatureLayer(dataS);
              app.map.addLayer(layerS);

              //add state data to Therewolf
              therewolf.add("States", dataS);

              //on map click, use Therewolf to find county and state containing click point
              app.map.on("click", function(evt){
                var result,
                    state,
                    county;
                result = therewolf.find([evt.mapPoint.x,evt.mapPoint.y]);
                if(result){
                  state = result.States ? result.States.STATE_NAME : "No Result";
                  county = result.Counties ? result.Counties.NAME : "No Result";
                }
                else{
                  state = "No Result";
                  county = "No Result";
                }
                dojo.byId("txtState").innerHTML = state;
                dojo.byId("txtCounty").innerHTML = county;
              });
            }, function(err){
              console.log("Error retrieving state data: ", err);
            });
          }, function(err){
            console.log("Error retrieving county data: ", err);
          });
        }
        init();
      });
    </script>
  </head>
  <body>
    <div id="map"></div>
    <p><span>State you clicked on: </span><span id="txtState"></span></p>
    <p><span>County you clicked on: </span><span id="txtCounty"></span></p>
  </body>
</html>
